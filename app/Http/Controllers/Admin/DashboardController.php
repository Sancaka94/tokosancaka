<?phpnamespace App\Http\Controllers\Admin;use App\Http\Controllers\Controller;use Illuminate\Http\Request;use App\Models\User;use App\Models\Pesanan;use App\Models\TopUp;use App\Models\ScannedPackage;use App\Models\Setting;use Illuminate\Support\Facades\DB;use Illuminate\Support\Facades\Cache;use Carbon\Carbon;use Illuminate\Notifications\DatabaseNotification;class DashboardController extends Controller{    public function index()    {        $cacheDuration = 600; // Durasi cache dalam detik (10 menit)        // --- Mengambil Statistik Utama (dengan Caching) ---        $stats = Cache::remember('admin_dashboard_stats_v9', $cacheDuration, function () {            // âœ… PERBAIKAN: Logika perhitungan pendapatan            $totalTopUp = TopUp::where('status', 'success')->sum('amount');            $totalOngkirPesanan = Pesanan::sum('total_harga_barang'); // Asumsi 'total_harga_barang' adalah pendapatan ongkir            // âœ… PERBAIKAN: Menggunakan 'role' (lowercase) sesuai standar            return [                'totalPendapatan' => $totalTopUp + $totalOngkirPesanan,                'totalPesanan' => Pesanan::count(),                'jumlahToko' => User::where('role', 'Toko')->count(),                'penggunaBaru' => User::where('role', 'Pelanggan')->where('created_at', '>=', now()->subDays(30))->count(),            ];        });        // --- Mengambil Notifikasi untuk Flasher (dengan Caching) ---        $notifications = Cache::remember('admin_dashboard_notifications_v7', 60, function () {            // âœ… PERBAIKAN: Menggunakan 'role' (lowercase)            return [                'pendaftaranBaru' => User::where('role', 'Pelanggan')->where('status', 'pending')->count(),                'pesananBaru' => Pesanan::where('status_pesanan', 'Menunggu Pickup')->count(),                'spxScanBaru' => ScannedPackage::whereDate('created_at', today())->count(),                'riwayatScanBaru' => ScannedPackage::whereDate('created_at', today())->count(), // Ini mungkin duplikat, sesuaikan jika perlu            ];        });        // --- Mengambil Data Grafik Pendapatan (dengan Caching) ---        $chartData = Cache::remember('admin_dashboard_revenue_chart_v4', $cacheDuration, function () {            // Menggunakan 'created_at' sebagai fallback jika 'tanggal_pesanan' tidak ada            $salesData = Pesanan::select(                DB::raw('DATE(created_at) as date'),                DB::raw('sum(total_harga_barang) as total')            )            ->where('created_at', '>=', now()->subDays(30))            ->groupBy('date')            ->orderBy('date', 'asc')            ->get()            ->pluck('total', 'date');            $dates = collect();            for ($i = 29; $i >= 0; $i--) {                $date = Carbon::now()->subDays($i)->format('Y-m-d');                $dates->put($date, 0);            }            $dailySales = $dates->merge($salesData);            return [                'labels' => $dailySales->keys()->map(function($date) {return Carbon::parse($date)->format('d M');})->toArray(),                'data' => $dailySales->values()->toArray(),            ];        });        // --- Mengambil Data Grafik Scan SPX (dengan Caching) ---        $spxChartData = Cache::remember('admin_dashboard_spx_chart_from_scans_v4', $cacheDuration, function () {            $spxData = ScannedPackage::select(                DB::raw('DATE(created_at) as date'),                DB::raw('COUNT(id) as total')            )            ->where('created_at', '>=', now()->subDays(30))            ->groupBy('date')            ->orderBy('date', 'asc')            ->get()            ->pluck('total', 'date');                        $dates = collect();            for ($i = 29; $i >= 0; $i--) {                $date = Carbon::now()->subDays($i)->format('Y-m-d');                $dates->put($date, 0);            }            $dailyScans = $dates->merge($spxData);            return [                'labels' => $dailyScans->keys()->map(fn($date) => Carbon::parse($date)->format('d M'))->toArray(),                'data' => $dailyScans->values()->toArray(),            ];        });        // --- Mengambil Data Tabel (dengan Caching) ---        $pesananTerbaru = Cache::remember('admin_dashboard_recent_orders_v4', $cacheDuration, function () {            // Menggunakan 'created_at' sebagai fallback            return Pesanan::with('pembeli')->latest('created_at')->take(5)->get();        });        $rekapEkspedisi = Cache::remember('admin_dashboard_rekap_ekspedisi_v9', $cacheDuration, function () {            // Daftar ekspedisi dan logonya            $logoMap = [    'J&T Express' => 'https://upload.wikimedia.org/wikipedia/commons/0/01/J%26T_Express_logo.svg',    'JNE' => 'https://upload.wikimedia.org/wikipedia/commons/9/92/New_Logo_JNE.png',    'POS Indonesia' => 'https://kiriminaja.com/assets/home-v4/pos.png',    'Indah Cargo' => 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEicOAaLoH2eElQ93_gbkzhvk4dRhWVlk5wQsGgilihIB58321aHchlJLdjyz1ToS25P_nWrHJ_E4QBiW_OVlI7tQt7cZ5I0HZqk6StS7jZltLVvDXp2d5ZDLB9yklhV4x6z2iXyURURDv_unhf-U6vyiD_8to9OC4PBwMwyU_5wAqOiCl6tKiaTA-ri1Q/s851/Logo%20Indah%20Logistik%20Cargo@0.5x.png',    'SAP Express' => 'https://kiriminaja.com/assets/home-v4/sap.png',    'ID Express' => 'https://kiriminaja.com/assets/home-v4/id-express.png',    'J&T Cargo' => 'https://i.pinimg.com/736x/22/cf/92/22cf92368c1f901d17e38e99061f4849.jpg',    'Lion Parcel' => 'https://kiriminaja.com/assets/home-v4/lion.png',    'SPX Express' => 'https://images.seeklogo.com/logo-png/49/1/spx-express-indonesia-logo-png_seeklogo-499970.png',    'Sicepat' => 'https://kiriminaja.com/assets/home-v4/sicepat.png',    'NCS Kurir' => 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxj3iyyZEjK2L4A4yCIr_E-4W3hF2lk_yb-t0Oj2oFPErCPCMHie5LHqps02xMb6sNa-Gqz5NSX_P_hzWlYpUpJUlCD4iN6_QxiSG9fzY4bsZ9XvLFDn7HCiORtNvIlPfuQbSSdW96p7x7uN8ek3FWyHW9c2bznrFBQkoLd5A9sVAFVKWLfUhT3Dxh/s320/GKL41_NCS%20Kurir%20-%20Koleksilogo.com.jpg',    'Ninja Express' => 'https://kiriminaja.com/assets/home-v4/ninja.png',    'Anteraja' => 'https://kiriminaja.com/assets/home-v4/anter-aja.png',    'TIKI' => 'https://kiriminaja.com/assets/home-v4/tiki.png',    'Sentral Cargo' => 'https://kiriminaja.com/assets/home-v4/central-cargo.png',    'Borzo' => 'https://kiriminaja.com/assets/home-v4/borzo.png',    'GoSend' => 'https://kiriminaja.com/assets/home-v4/gosend.png',    'GrabExpress' => 'https://kiriminaja.com/assets/home-v4/grab.svg',    // Tetap tambahkan milikmu sendiri    'Sancaka Express' => 'https://tokosancaka.biz.id/storage/uploads/sancaka.png',];                        $ekspedisiData = Pesanan::query()                ->selectRaw('expedition as nama, COUNT(id_pesanan) as total_order, COUNT(DISTINCT id_pengguna_pembeli) as total_pelanggan, SUM(total_harga_barang) as total_profit')                ->whereNotNull('expedition')->where('expedition', '!=', '')->groupBy('expedition')->get()->keyBy('nama');                        return collect($logoMap)->map(function ($logoUrl, $namaEkspedisi) use ($ekspedisiData) {                $data = $ekspedisiData->get($namaEkspedisi);                return (object) [                    'nama' => $namaEkspedisi, 'logo' => $logoUrl,                    'total_order' => optional($data)->total_order ?? 0,                    'total_pelanggan' => optional($data)->total_pelanggan ?? 0,                    'total_profit' => optional($data)->total_profit ?? 0,                ];            })->sortByDesc('total_order')->values();        });        // --- Mengambil data notifikasi terbaru untuk tabel ---        $recentNotifications = DatabaseNotification::latest()->take(10)->get();        // --- Mengambil data slider dari tabel settings ---        $sliderData = Setting::where('key', 'dashboard_slider')->first();        $slides = $sliderData ? json_decode($sliderData->value, true) : [];        // --- Melewatkan semua data ke view ---        return view('admin.dashboard', array_merge($stats, [            'chartData' => $chartData,            'spxChartData' => $spxChartData,            'pesananTerbaru' => $pesananTerbaru,            'rekapEkspedisi' => $rekapEkspedisi,            'notifications' => $notifications,            'recentNotifications' => $recentNotifications,            'slides' => $slides,        ]));    }}